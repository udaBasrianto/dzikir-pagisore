rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Rules untuk koleksi users
    match /users/{userId} {
      // User bisa read/write data mereka sendiri
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admin dan superadmin bisa read semua user
      allow read: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']);
      
      // Superadmin bisa update role user lain
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Rules untuk koleksi dzikir
    match /dzikir/{dzikirId} {
      // Semua authenticated user bisa read dzikir
      allow read: if request.auth != null;
      
      // User dengan role admin, contributor, atau superadmin bisa write
      allow create, update, delete: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'contributor', 'superadmin']);
      
      // Anonymous user bisa read dzikir yang published
      allow read: if resource.data.status == 'published';
    }
    
    // Rules untuk koleksi categories
    match /categories/{categoryId} {
      // Semua user bisa read categories
      allow read: if true;
      
      // Hanya admin dan superadmin yang bisa modify categories
      allow create, update, delete: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']);
    }
    
    // Rules untuk global stats dan user progress
    match /globalStats/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /userProgress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Rules untuk user counters dan achievements
    match /userCounters/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /userAchievements/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Rules untuk leaderboard
    match /leaderboard/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}